<!DOCTYPE html>
<html>
<head>
    <title>ABCJS Music Display with Controls</title>
    <script src="https://cdn.jsdelivr.net/npm/abcjs@6.2.3/dist/abcjs-basic-min.js"></script>
    
    <style>
      .highlight {
        fill: #0a9ecc;
      }
      
      .abcjs-cursor {
        stroke: red;
      }
      
      .abcjs-css-warning {
        display:none;
      }
    </style>

    <script>
    
        function CursorControl() {
          var self = this;

          self.onReady = function() {
          };
          self.onStart = function() {
            var svg = document.querySelector("#paper svg");
            var cursor = document.createElementNS("http://www.w3.org/2000/svg", "line");
            cursor.setAttribute("class", "abcjs-cursor");
            cursor.setAttributeNS(null, 'x1', 0);
            cursor.setAttributeNS(null, 'y1', 0);
            cursor.setAttributeNS(null, 'x2', 0);
            cursor.setAttributeNS(null, 'y2', 0);
            svg.appendChild(cursor);

          };
          self.beatSubdivisions = 2;
          self.onBeat = function(beatNumber, totalBeats, totalTime) { };
          self.onEvent = function(ev) {
            if (ev.measureStart && ev.left === null)
              return; // this was the second part of a tie across a measure line. Just ignore it.

            var lastSelection = document.querySelectorAll("#paper svg .highlight");
            for (var k = 0; k < lastSelection.length; k++)
              lastSelection[k].classList.remove("highlight");

            JSON.stringify(ev, null, 4);
            for (var i = 0; i < ev.elements.length; i++ ) {
              var note = ev.elements[i];
              for (var j = 0; j < note.length; j++) {
                note[j].classList.add("highlight");
              }
            }

            var cursor = document.querySelector("#paper svg .abcjs-cursor");
            if (cursor) {
              cursor.setAttribute("x1", ev.left - 2);
              cursor.setAttribute("x2", ev.left - 2);
              cursor.setAttribute("y1", ev.top);
              cursor.setAttribute("y2", ev.top + ev.height);
            }
          };
          self.onFinished = function() {
            var els = document.querySelectorAll("svg .highlight");
            for (var i = 0; i < els.length; i++ ) {
              els[i].classList.remove("highlight");
            }
            var cursor = document.querySelector("#paper svg .abcjs-cursor");
            if (cursor) {
              cursor.setAttribute("x1", 0);
              cursor.setAttribute("x2", 0);
              cursor.setAttribute("y1", 0);
              cursor.setAttribute("y2", 0);
            }
          };
        }

        var cursorControl = new CursorControl();

    
        // Global variables for ABCJS synth control
        var synthControl;
        var currentNotationInstance;
        
        function clickListener(abcElem, tuneNumber, classes, analysis, drag, mouseEvent) {
          var lastClicked = abcElem.midiPitches;
          if (!lastClicked)
            return;

          ABCJS.synth.playEvent(lastClicked, abcElem.midiGraceNotePitches, synthControl.visualObj.millisecondsPerMeasure()).then(function (response) {
            console.log("note played");
          }).catch(function (error) {
            console.log("error playing note", error);
          });
        }
        
        var abcOptions = {
          add_classes: true,
          clickListener: clickListener,
          responsive: "resize"
        };
        
        function loadAndDisplayABC(uri) {
            fetch(uri)
                .then(response => response.text())
                .then(abcNotation => {
                    if (abcNotation) {
                        // Render ABC Notation
                        currentNotationInstance = ABCJS.renderAbc("paper", abcNotation, abcOptions)[0];

                        // Attach Synthesizer to Rendered Notation
                        synthControl.setTune(currentNotationInstance, false);
                    } else {
                        console.error("No ABC notation found at the URI.");
                    }
                })
                .catch(error => console.error("Error loading ABC notation:", error));
        }

        function initializeSynthControl() {
            synthControl = new ABCJS.synth.SynthController();
            synthControl.load("#audio", cursorControl, {
                displayLoop: true, 
                displayRestart: true, 
                displayPlay: true, 
                displayProgress: true,
                displayWarp: true
            });
        }

        function setupEventHandlers() {
            document.getElementById("downloadMidi").addEventListener("click", function() {
                if (!currentNotationInstance)
                  return;

                var midi = ABCJS.synth.getMidiFile(currentNotationInstance);
                var element = document.createElement('a');
                element.setAttribute('href', 'data:audio/midi;charset=utf-8,' + encodeURIComponent(midi));
                element.setAttribute('download', "music.mid");

                element.style.display = 'none';
                document.body.appendChild(element);

                element.click();

                document.body.removeChild(element);
            });
        }

        window.onload = function() {
            var uri = getParameterByName('uri');
            if (uri) {
                initializeSynthControl();
                loadAndDisplayABC(uri);
                setupEventHandlers();
            } else {
                console.error("No URI provided in the 'uri' GET parameter.");
            }
        };

        // Function to get the value of a GET parameter by name
        function getParameterByName(name, url = window.location.href) {
            name = name.replace(/[\[\]]/g, '\\$&');
            var regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)'),
                results = regex.exec(url);
            if (!results) return null;
            if (!results[2]) return '';
            return decodeURIComponent(results[2].replace(/\+/g, ' '));
        }
    </script>
</head>
<body>
    <div id="audio"></div>
    <div id="paper"></div>
    <button id="downloadMidi">Download MIDI</button>
</body>
</html>
